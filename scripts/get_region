#!/usr/local/bin/perl

$| = 1;

use strict;
use Getopt::Long;

use Bio::Otter::DBSQL::DBAdaptor;
use Bio::Otter::CloneLockBroker;
use Bio::Otter::Converter;
use Bio::Otter::Author;

my $otterhost     = 'localhost';
my $otteruser     = 'root';
my $otterpass     = '';
my $otterport     = 3306;
my $ottername     = 'test_otter';

my $dna_host      = 'kaka.sanger.ac.uk';
my $dna_user      = 'anonymous';
my $dna_port      = 3306;
my $dna_pass      = undef;
my $dna_dbname    = undef;

my $chr           = 'CHR';
my $chrstart      = 1;
my $chrend        = 1000000;

my $type          = 'test_otter';
my $lock          = 'false';

my $name   = `whoami`; chomp($name);
my $mail   = $name . '@sanger.ac.uk';

&GetOptions( 'otterhost:s'    => \$otterhost,
             'otteruser:s'    => \$otteruser,
             'otterpass:s'    => \$otterpass,
             'otterport:s'    => \$otterport,
             'ottername:s'    => \$ottername,
             'dna_host:s'     => \$dna_host,
             'dna_user:s'     => \$dna_user,
             'dna_pass:s'     => \$dna_pass,
             'dna_port:s'     => \$dna_port,
             'dna_dbname:s'   => \$dna_dbname,
             'chr:s'          => \$chr,
             'chrstart:n'     => \$chrstart,
             'chrend:n'       => \$chrend,
             'author:s'       => \$name,
             'email:s'        => \$mail,
             'lock:s'         => \$lock, 
	     'type:s'         => \$type);

my $odb = new Bio::Otter::DBSQL::DBAdaptor(-host => $otterhost,
					   -user => $otteruser,
					   -pass => $otterpass,
					   -port => $otterport,        
					   -dbname => $ottername);


if (defined($dna_dbname)) {
    my $dnadb = new Bio::EnsEMBL::DBSQL::DBAdaptor(-host => $dna_host,
						   -user => $dna_user,
						   -pass => $dna_pass,
						   -port => $dna_port,
						   -dbname => $dna_dbname);
    $odb->dnadb($dnadb);
}


my $sgp  = $odb->get_SliceAdaptor;
my $aga  = $odb->get_AnnotatedGeneAdaptor;

my $cb   = new Bio::Otter::CloneLockBroker($odb);

$odb->assembly_type($type);  



my $author = new Bio::Otter::Author(-name  => $name,
				    -email => $mail);

my $slice = $sgp->fetch_by_chr_start_end($chr,$chrstart,$chrend);

eval {
  if ($lock ne "true") {
    my @locks = $cb->lock_clones_by_slice($slice,$author);
  }
}; 

if ($@) {
    print "Clones locked - exiting [$@]\n";
    exit(0);
}
my $xmlstr = Bio::Otter::Converter::slice_to_XML($slice,$odb);
print $xmlstr . "\n";

