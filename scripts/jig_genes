#!/usr/local/bin/perl
$| = 1;
use strict;
use Getopt::Long;

use Bio::Otter::DBSQL::DBAdaptor;
use Bio::Otter::DBSQL::AnnotatedGeneAdaptor;
use Bio::Otter::Converter;
use Bio::Otter::Author;
use Bio::Otter::AnnotationBroker;

my $host     = 'localhost';
my $user     = 'root';
my $pass     = '';
my $port     = 3306;
my $dbname   = 'test_otter';

my $dna_host   = 'ecs1d';
my $dna_user   = 'ensro';
my $dna_port   = 3306;
my $dna_pass   = undef;
my $dna_dbname = undef;

my $chr      = '6';
my $chrstart = 1;
my $chrend   = 2000000;

my $type;

my $store;
my $print;

my $acefile;
my $xmlfile;
my $dbfile;

&GetOptions( 'host:s'    => \$host,
             'user:s'    => \$user,
             'pass:s'    => \$pass,
             'port:s'    => \$port,
             'dbname:s'  => \$dbname,
             'dna_host:s'=> \$dna_host,
             'dna_user:s'=> \$dna_user,
             'dna_pass:s'=> \$dna_pass,
             'dna_port:s'=> \$dna_port,
             'dna_dbname:s'  => \$dna_dbname,
             'chr:s'     => \$chr,
             'chrstart:n'=> \$chrstart,
             'chrend:n'  => \$chrend,
             'type:s'    => \$type,
             );

  my $odb = new Bio::Otter::DBSQL::DBAdaptor(-host => $host,
                                             -user => $user,
                                             -pass => $pass,
                                             -port => $port,        
                                             -dbname => $dbname);

  $odb->assembly_type($type) if ($type);

  if (defined($dna_dbname)) {
    my $dnadb = new Bio::EnsEMBL::DBSQL::DBAdaptor(-host => $dna_host,
                                                 -user => $dna_user,
                                                 -pass => $dna_pass,
                                                 -port => $dna_port,
                                                 -dbname => $dna_dbname);
    $odb->dnadb($dnadb);
  }

my $ab = new Bio::Otter::AnnotationBroker($odb);
my $ga = $odb->get_GeneAdaptor;

my $sgp = $odb->get_SliceAdaptor;

my $vcontig = $sgp->fetch_by_chr_start_end($chr,$chrstart,$chrend);

my @play_genes = @{$ga->fetch_by_Slice($vcontig)};
my @hard_genes = @{$ga->fetch_by_Slice($vcontig)};

$odb->begin_work();

foreach my $gene ( @play_genes ) {
    my $chg = 0;
    print "Gene $gene\n";
    foreach my $trans ( @{$gene->get_all_Transcripts()} ) {
	foreach my $exon ( @{$trans->get_all_Exons()} ) {
	    if( rand 1 < 0.025 ) {
		$exon->start($exon->start+ int(rand(10)) );
		$chg = 1;
	    }

	    if( rand 1 < 0.025 ) {
		$exon->start($exon->start- int(rand(10)) );
		$chg = 1;
	    }

	    if( rand 1 < 0.025 ) {
		$exon->start($exon->end+ int(rand(10)) );
		$chg = 1;
	    }

	    if( rand 1 < 0.025 ) {
		$exon->start($exon->end- int(rand(10)) );
		$chg = 1;
	    }
	}
    }
}

# the magic happens!
my @events = $ab->compare_genes(\@hard_genes,\@play_genes,$vcontig);

foreach my $event ( @events ) {
    print $event->to_string,"\n";
}

#$odb->rollback();
$odb->commit;

