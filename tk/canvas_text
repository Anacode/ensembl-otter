#!/usr/local/bin/perl -w

### canvas_text

use strict;
use GenomeCanvas;

{
    my $mw = GenomeCanvas::MainWindow->new;
    $mw->title('Text test');
    $mw->bind(<Control-q>, sub {exit 0});
    $mw->bind(<Control-Q>, sub {exit 0});
    
    my $gc = GenomeCanvas->new($mw);
    
    my $canvas = $gc->canvas;
    my $rec = $canvas->createRectangle(1,1,500,200,
        -fill       => '#ffffff',
        -outline    => '#999999',
        );
    warn $rec;
    $canvas->bind($rec, '<Button-1>', \&deselect_text);
    
    $canvas->eventAdd('<<alpha_num>>', map "<KeyPress-$_>", ' ', "a".."z", "A".."Z", 0..9);
    my $size = 14;
    my $x = 10;
    my $y_begin = $x;
    for (my $i = 0; $i < 11; $i++) {
        my $y = $y_begin + ($i * $size + $i);
        my $row_num = $i + 1;
        my $text = "Text in row $row_num";
        make_editable_label($canvas, $x, $y, $text, $size);
    }
    
    $gc->fix_window_min_max_sizes;
    
    Tk::MainLoop();
}

sub make_editable_label {
    my( $canvas, $x, $y, $text, $size ) = @_;
    
    $size ||= 15;
    
    my $t = $canvas->createText(
        $x,$y,
        -anchor => 'nw',
        -text   => $text,
        -font   => ['lucidatypewriter', $size, 'normal'],
        -tags   => ['test text'],
        );
    $canvas->bind($t, '<Button-1>',     \&select_text);
    $canvas->bind($t, '<BackSpace>',    \&backspace);
    $canvas->bind($t, '<Left>',         \&go_left);
    $canvas->bind($t, '<Right>',        \&go_right);
    $canvas->bind($t, '<<alpha_num>>',  [\&insert_character, Tk::Ev('A')]);
}

BEGIN {

    my $rec_tag = 'SelectedTextBkgd';
    my $current_text = 0;

    sub backspace {
        my( $canvas ) = @_;

        my $text = $canvas->find('withtag', 'current');

        my $pos = $canvas->index($text, 'insert');
        $canvas->dchars($text, $pos - 1);
    }

    sub go_left {
        my( $canvas ) = @_;

        my $text = $canvas->find('withtag', 'current');

        my $pos = $canvas->index($text, 'insert');
        $canvas->icursor($text, $pos - 1);
    }

    sub go_right {
        my( $canvas ) = @_;

        my $text = $canvas->find('withtag', 'current');

        my $pos = $canvas->index($text, 'insert');
        $canvas->icursor($text, $pos + 1);
    }

    sub select_text {
        my( $canvas ) = @_;

        my $text = $canvas->find('withtag', 'current');
        if ($text == $current_text) {
            # position pointer
        } else {
            deselect_text();
            make_highlight_rectangle($canvas, $text);

            $canvas->focus($text);
            $canvas->icursor($text, 'end');
        }
        $current_text = $text;
    }

    sub make_highlight_rectangle {
        my( $canvas, $obj ) = @_;
        
        # Make the highlight rectangle
        my @bbox = $canvas->bbox($obj);
        my $rec = $canvas->createRectangle(
            @bbox,
            -fill       => '#ffff00',
            -outline    => undef,
            -tags       => [$rec_tag],
            );
        $canvas->lower($rec, $obj);
    }

    sub deselect_text {
        my( $canvas ) = @_;

        return unless $current_text;
        $canvas->delete($rec_tag);
        $canvas->focus("");
        $current_text = 0;
    }
    
    sub insert_character {
        my( $canvas, $char ) = @_;
        
        return unless $char =~ /^[a-zA-Z0-9 ]$/;
        
        my $text = $canvas->find('withtag', 'current');
        $canvas->insert('current', 'insert', $char);
        
        $canvas->delete($rec_tag);
        make_highlight_rectangle($canvas, $text);
    }
}

__END__

=head1 NAME - canvas_text

=head1 AUTHOR

James Gilbert B<email> jgrg@sanger.ac.uk

